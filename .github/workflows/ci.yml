# CI â€“ create a build release artifact after tests pass
# This runs only after the "Unit Tests â€“ GameMaker Project" workflow completes successfully.
name: CI â€“ Build & Release after Tests

on:
  workflow_run:
    workflows:
      - "Unit Tests â€“ GameMaker Project"
    types:
      - completed

jobs:
  build-and-release:
    name: Build project and create release
    runs-on: ubuntu-latest
    # only run when the upstream workflow completed successfully
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: CI banner
        run: |
          echo "ðŸš€ Build/Release triggered by successful tests"
          echo "Upstream workflow run id: ${{ github.event.workflow_run.id }}"
          echo "Commit: ${{ github.event.workflow_run.head_sha }}"

      - name: Create build archive
        id: archive
        run: |
          PKG="Tower Defense v1(back up6)"
          SHORTSHA=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-8)
          ARCHIVE_NAME="tower-defense-build-${SHORTSHA}.zip"
          if [ ! -d "$PKG" ]; then
            echo "Project directory '$PKG' not found"
            exit 1
          fi
          zip -r "$ARCHIVE_NAME" "$PKG"
          echo "archive=$ARCHIVE_NAME" >> $GITHUB_OUTPUT

      - name: Create draft release
        id: create_release
        uses: peter-evans/create-release@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: build-${{ github.event.workflow_run.head_sha }}
          release_name: "Build - ${{ github.event.workflow_run.head_sha }}"
          draft: true
          prerelease: false
          body: |
            Auto-generated build from successful test workflow run.
            Workflow run id: ${{ github.event.workflow_run.id }}
            Commit: ${{ github.event.workflow_run.head_sha }}

      - name: Upload build artifact to release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.archive.outputs.archive }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Finish
        run: echo "âœ… Draft release created and build artifact uploaded. Release tag: build-${{ github.event.workflow_run.head_sha }}"
