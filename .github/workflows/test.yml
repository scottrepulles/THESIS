name: Unit Tests â€“ Tower Defense (GameMaker)

on:
  push:
    branches: [cicd]
  pull_request:
    branches: [cicd]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
    # ==================================================
    # SETUP
    # ==================================================
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Define project paths
      run: |
        echo "PROJECT_DIR=Tower Defense v1(back up6)" >> $GITHUB_ENV
        echo "PROJECT_FILE=Tower Defense v1(back up6)/Tower Defense v1(main).yyp" >> $GITHUB_ENV

    # ==================================================
    # UNIT TEST 1 â€” Project file exists
    # ==================================================
    - name: Unit Test 1 â€” Project file exists
      run: test -f "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 2 â€” Project file readable
    # ==================================================
    - name: Unit Test 2 â€” Project file readable
      run: test -r "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 3 â€” Valid JSON (STRICT)
    # ==================================================
    - name: Unit Test 3 â€” Valid JSON
      run: jq empty "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 4 â€” GameMaker project type
    # ==================================================
    - name: Unit Test 4 â€” GameMaker project type
      run: |
        jq -e '.resourceType=="GMProject"' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 5 â€” isEcma configuration (REAL ASSERTION)
    # ==================================================
    - name: Unit Test 5 â€” Validate isEcma configuration
      run: |
        VALUE=$(jq -r '.isEcma' "$PROJECT_FILE")
        [ "$VALUE" = "false" ]

    # ==================================================
    # UNIT TEST 6 â€” Required root keys exist
    # ==================================================
    - name: Unit Test 6 â€” Required root keys
      run: |
        for k in resources Folders RoomOrderNodes TextureGroups AudioGroups; do
          jq -e ".$k" "$PROJECT_FILE" > /dev/null
        done

    # ==================================================
    # UNIT TEST 7 â€” Required directories exist
    # ==================================================
    - name: Unit Test 7 â€” Required directories
      run: |
        for d in fonts notes objects paths rooms scripts sequences shaders sounds sprites; do
          test -d "$PROJECT_DIR/$d"
        done

    # ==================================================
    # UNIT TEST 8 â€” At least one script exists
    # ==================================================
    - name: Unit Test 8 â€” Scripts exist
      run: find "$PROJECT_DIR/scripts" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 9 â€” At least one object exists
    # ==================================================
    - name: Unit Test 9 â€” Objects exist
      run: find "$PROJECT_DIR/objects" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 10 â€” At least one room exists
    # ==================================================
    - name: Unit Test 10 â€” Rooms exist
      run: find "$PROJECT_DIR/rooms" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 11 â€” Resource ID uniqueness (CORRECT)
    # ==================================================
    - name: Unit Test 11 â€” Unique resource IDs
      run: |
        jq -r '.resources[].id | "\(.name)|\(.path)"' "$PROJECT_FILE" \
        | sort | uniq -d | tee /tmp/dupes.txt
        test ! -s /tmp/dupes.txt

    # ==================================================
    # UNIT TEST 12 â€” Resource paths exist on disk
    # ==================================================
    - name: Unit Test 12 â€” Resource paths valid
      run: |
        jq -r '.resources[].id.path' "$PROJECT_FILE" | while read p; do
          test -f "$PROJECT_DIR/$p"
        done

    # ==================================================
    # UNIT TEST 13 â€” RoomOrderNodes not empty
    # ==================================================
    - name: Unit Test 13 â€” RoomOrderNodes not empty
      run: jq -e '.RoomOrderNodes | length > 0' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 14 â€” RoomOrderNodes reference valid rooms
    # ==================================================
    - name: Unit Test 14 â€” RoomOrderNodes valid
      run: |
        jq -r '.RoomOrderNodes[].roomId.path' "$PROJECT_FILE" | while read r; do
          test -f "$PROJECT_DIR/$r"
        done

    # ==================================================
    # UNIT TEST 15 â€” Rooms declared in resources
    # ==================================================
    - name: Unit Test 15 â€” Rooms declared in resources
      run: |
        jq -r '.RoomOrderNodes[].roomId.path' "$PROJECT_FILE" | while read r; do
          jq -e --arg p "$r" '.resources[].id.path | select(.==$p)' "$PROJECT_FILE" > /dev/null
        done

    # ==================================================
    # UNIT TEST 16 â€” AudioGroups exist
    # ==================================================
    - name: Unit Test 16 â€” AudioGroups exist
      run: jq -e '.AudioGroups | length > 0' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 17 â€” Default AudioGroup exists
    # ==================================================
    - name: Unit Test 17 â€” Default AudioGroup
      run: jq -e '.AudioGroups[].name | select(.=="audiogroup_default")' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 18 â€” TextureGroups exist
    # ==================================================
    - name: Unit Test 18 â€” TextureGroups exist
      run: jq -e '.TextureGroups | length > 0' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 19 â€” Default TextureGroup exists
    # ==================================================
    - name: Unit Test 19 â€” Default TextureGroup
      run: jq -e '.TextureGroups[].name | select(.=="Default")' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 20 â€” Scripts referenced exist
    # ==================================================
    - name: Unit Test 20 â€” Script resources valid
      run: |
        jq -r '.resources[].id.path | select(startswith("scripts/"))' "$PROJECT_FILE" \
        | while read s; do
            test -f "$PROJECT_DIR/$s"
          done

    # ==================================================
    # UNIT TEST 21 â€” No empty resource list
    # ==================================================
    - name: Unit Test 21 â€” Resources not empty
      run: jq -e '.resources | length > 0' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 22 â€” Template type is game
    # ==================================================
    - name: Unit Test 22 â€” Template type
      run: jq -e '.templateType=="game"' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 23 â€” Metadata IDEVersion exists
    # ==================================================
    - name: Unit Test 23 â€” IDE metadata exists
      run: jq -e '.MetaData.IDEVersion' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 24 â€” Project name matches file
    # ==================================================
    - name: Unit Test 24 â€” Project name correct
      run: |
        NAME=$(jq -r '.name' "$PROJECT_FILE")
        [ "$NAME" = "Tower Defense v1(main)" ]

    # ==================================================
    # END
    # ==================================================
    - name: Unit Tests Complete
      run: echo "ðŸŽ‰ All 24 REAL unit tests passed â€” GameMaker project validated"
