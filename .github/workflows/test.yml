name: Unit Tests â€“ Tower Defense (GameMaker)

on:
  push:
    branches: [cicd]
  pull_request:
    branches: [cicd]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
    # ==================================================
    # SETUP
    # ==================================================
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Define project paths
      run: |
        echo "PROJECT_DIR=Tower Defense v1(back up6)" >> $GITHUB_ENV
        echo "PROJECT_FILE=Tower Defense v1(back up6)/Tower Defense v1(main).yyp" >> $GITHUB_ENV

    # ==================================================
    # UNIT TEST 1 â€” Project file exists
    # ==================================================
    - name: Unit Test 1 â€” Project file exists
      run: |
        set -euo pipefail
        test -f "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 2 â€” Project file readable
    # ==================================================
    - name: Unit Test 2 â€” Project file readable
      run: |
        set -euo pipefail
        test -r "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 3 â€” Valid JSON
    # ==================================================
    - name: Unit Test 3 â€” Valid JSON
      run: |
        set -euo pipefail
        python3 -m json.tool "$PROJECT_FILE" > /dev/null

    # ==================================================
    # UNIT TEST 4 â€” GameMaker project type
    # ==================================================
    - name: Unit Test 4 â€” GameMaker project type
      run: |
        set -euo pipefail
        python3 - << EOF
import json, os
with open(os.environ["PROJECT_FILE"]) as f:
    d = json.load(f)
assert d.get("resourceType") == "GMProject"
EOF

    # ==================================================
    # UNIT TEST 5 â€” isEcma configuration (REAL)
    # ==================================================
    - name: Unit Test 5 â€” isEcma configuration
      run: |
        set -euo pipefail
        python3 - << EOF
import json, os
with open(os.environ["PROJECT_FILE"]) as f:
    d = json.load(f)
assert "isEcma" in d
assert d["isEcma"] is False
EOF

    # ==================================================
    # UNIT TEST 6 â€” Required root keys
    # ==================================================
    - name: Unit Test 6 â€” Required root keys
      run: |
        set -euo pipefail
        python3 - << EOF
import json, os
with open(os.environ["PROJECT_FILE"]) as f:
    d = json.load(f)
for k in ["resources","Folders","RoomOrderNodes","TextureGroups"]:
    assert k in d and len(d[k]) > 0
EOF

    # ==================================================
    # UNIT TEST 7 â€” Required directories exist
    # ==================================================
    - name: Unit Test 7 â€” Required directories exist
      run: |
        set -euo pipefail
        for d in fonts notes objects paths rooms scripts sequences shaders sounds sprites; do
          test -d "$PROJECT_DIR/$d"
        done

    # ==================================================
    # UNIT TEST 8 â€” Scripts exist
    # ==================================================
    - name: Unit Test 8 â€” Scripts exist
      run: |
        set -euo pipefail
        find "$PROJECT_DIR/scripts" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 9 â€” Objects exist
    # ==================================================
    - name: Unit Test 9 â€” Objects exist
      run: |
        set -euo pipefail
        find "$PROJECT_DIR/objects" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 10 â€” Rooms exist
    # ==================================================
    - name: Unit Test 10 â€” Rooms exist
      run: |
        set -euo pipefail
        find "$PROJECT_DIR/rooms" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 11 â€” Resource paths exist
    # ==================================================
    - name: Unit Test 11 â€” Resource paths exist
      run: |
        set -euo pipefail
        python3 - << EOF
import json, os
root = os.environ["PROJECT_DIR"]
with open(os.environ["PROJECT_FILE"]) as f:
    d = json.load(f)
for r in d["resources"]:
    p = os.path.join(root, r["id"]["path"])
    assert os.path.isfile(p), p
EOF

    # ==================================================
    # UNIT TEST 12 â€” No duplicate resource paths
    # ==================================================
    - name: Unit Test 12 â€” No duplicate resource paths
      run: |
        set -euo pipefail
        python3 - << EOF
import json, os
with open(os.environ["PROJECT_FILE"]) as f:
    d = json.load(f)
paths = [r["id"]["path"] for r in d["resources"]]
assert len(paths) == len(set(paths))
EOF

    # ==================================================
    # UNIT TEST 13 â€” RoomOrderNodes valid
    # ==================================================
    - name: Unit Test 13 â€” RoomOrderNodes valid
      run: |
        set -euo pipefail
        python3 - << EOF
import json, os
root = os.environ["PROJECT_DIR"]
with open(os.environ["PROJECT_FILE"]) as f:
    d = json.load(f)
for r in d["RoomOrderNodes"]:
    p = os.path.join(root, r["roomId"]["path"])
    assert os.path.isfile(p)
EOF

    # ==================================================
    # UNIT TEST 14 â€” At least one room
    # ==================================================
    - name: Unit Test 14 â€” At least one room
      run: |
        set -euo pipefail
        python3 - << EOF
import json, os
with open(os.environ["PROJECT_FILE"]) as f:
    d = json.load(f)
assert len(d["RoomOrderNodes"]) > 0
EOF

    # ==================================================
    # UNIT TEST 15 â€” At least one script
    # ==================================================
    - name: Unit Test 15 â€” At least one script
      run: |
        set -euo pipefail
        python3 - << EOF
import json, os
with open(os.environ["PROJECT_FILE"]) as f:
    d = json.load(f)
assert any(r["id"]["path"].startswith("scripts/") for r in d["resources"])
EOF

    # ==================================================
    # UNIT TEST 16 â€” At least one object
    # ==================================================
    - name: Unit Test 16 â€” At least one object
      run: |
        set -euo pipefail
        python3 - << EOF
import json, os
with open(os.environ["PROJECT_FILE"]) as f:
    d = json.load(f)
assert any(r["id"]["path"].startswith("objects/") for r in d["resources"])
EOF

    # ==================================================
    # UNIT TEST 17 â€” At least one sprite
    # ==================================================
    - name: Unit Test 17 â€” At least one sprite
      run: |
        set -euo pipefail
        python3 - << EOF
import json, os
with open(os.environ["PROJECT_FILE"]) as f:
    d = json.load(f)
assert any(r["id"]["path"].startswith("sprites/") for r in d["resources"])
EOF

    # ==================================================
    # UNIT TEST 18 â€” TextureGroups exist
    # ==================================================
    - name: Unit Test 18 â€” TextureGroups exist
      run: |
        set -euo pipefail
        python3 - << EOF
import json, os
with open(os.environ["PROJECT_FILE"]) as f:
    d = json.load(f)
assert len(d["TextureGroups"]) > 0
EOF

    # ==================================================
    # UNIT TEST 19 â€” Resources list not empty
    # ==================================================
    - name: Unit Test 19 â€” Resources list not empty
      run: |
        set -euo pipefail
        python3 - << EOF
import json, os
with open(os.environ["PROJECT_FILE"]) as f:
    d = json.load(f)
assert len(d["resources"]) > 0
EOF

    # ==================================================
    # END
    # ==================================================
    - name: Unit Tests Complete
      run: echo "ðŸŽ‰ All unit tests passed (REAL & STRICT)"
