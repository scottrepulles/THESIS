name: Unit Tests â€“ Tower Defense (GameMaker)

on:
  push:
    branches: [cicd]
  pull_request:
    branches: [cicd]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
    # ==================================================
    # SETUP
    # ==================================================
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Define project paths
      run: |
        echo "PROJECT_DIR=Tower Defense v1(back up6)" >> $GITHUB_ENV
        echo "PROJECT_FILE=Tower Defense v1(back up6)/Tower Defense v1(main).yyp" >> $GITHUB_ENV

    # ==================================================
    # UNIT TEST 1 â€” Project file exists
    # ==================================================
    - name: Unit Test 1 â€” Project file exists
      run: |
        set -e
        test -f "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 2 â€” Project file readable
    # ==================================================
    - name: Unit Test 2 â€” Project file readable
      run: |
        set -e
        test -r "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 3 â€” GameMaker project signature
    # ==================================================
    - name: Unit Test 3 â€” GameMaker project signature
      run: |
        set -e
        grep -q '"$GMProject"' "$PROJECT_FILE"
        grep -q '"resourceType":"GMProject"' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 4 â€” isEcma configuration (REAL FAILURE TEST)
    # ==================================================
    - name: Unit Test 4 â€” isEcma must be false
      run: |
        set -e
        VALUE=$(grep '"isEcma"' "$PROJECT_FILE" | head -n 1)
        echo "Detected isEcma: $VALUE"
        echo "$VALUE" | grep -q 'false'

    # ==================================================
    # UNIT TEST 5 â€” Required root sections exist
    # ==================================================
    - name: Unit Test 5 â€” Required root sections
      run: |
        set -e
        for k in '"resources"' '"Folders"' '"RoomOrderNodes"' '"TextureGroups"' '"AudioGroups"'; do
          grep -q "$k" "$PROJECT_FILE"
        done

    # ==================================================
    # UNIT TEST 6 â€” Required directories exist
    # ==================================================
    - name: Unit Test 6 â€” Required directories exist
      run: |
        set -e
        for d in fonts notes objects paths rooms scripts sequences shaders sounds sprites; do
          test -d "$PROJECT_DIR/$d"
        done

    # ==================================================
    # UNIT TEST 7 â€” Scripts exist
    # ==================================================
    - name: Unit Test 7 â€” Scripts exist
      run: |
        set -e
        find "$PROJECT_DIR/scripts" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 8 â€” Objects exist
    # ==================================================
    - name: Unit Test 8 â€” Objects exist
      run: |
        set -e
        find "$PROJECT_DIR/objects" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 9 â€” Rooms exist
    # ==================================================
    - name: Unit Test 9 â€” Rooms exist
      run: |
        set -e
        find "$PROJECT_DIR/rooms" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 10 â€” Fonts exist
    # ==================================================
    - name: Unit Test 10 â€” Fonts exist
      run: |
        set -e
        find "$PROJECT_DIR/fonts" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 11 â€” Sprites exist
    # ==================================================
    - name: Unit Test 11 â€” Sprites exist
      run: |
        set -e
        find "$PROJECT_DIR/sprites" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 12 â€” Sounds exist
    # ==================================================
    - name: Unit Test 12 â€” Sounds exist
      run: |
        set -e
        find "$PROJECT_DIR/sounds" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 13 â€” Sequences exist
    # ==================================================
    - name: Unit Test 13 â€” Sequences exist
      run: |
        set -e
        find "$PROJECT_DIR/sequences" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 14 â€” Shaders exist
    # ==================================================
    - name: Unit Test 14 â€” Shaders exist
      run: |
        set -e
        find "$PROJECT_DIR/shaders" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 15 â€” Resource paths valid
    # ==================================================
    - name: Unit Test 15 â€” Resource paths valid
      run: |
        set -e
        grep '"path":"' "$PROJECT_FILE" \
        | sed -E 's/.*"path":"([^"]+)".*/\1/' \
        | while read p; do
            test -f "$PROJECT_DIR/$p"
          done

    # ==================================================
    # UNIT TEST 16 â€” No duplicate resource paths
    # ==================================================
    - name: Unit Test 16 â€” No duplicate resource paths
      run: |
        set -e
        DUPES=$(grep '"path":"' "$PROJECT_FILE" | sort | uniq -d)
        test -z "$DUPES"

    # ==================================================
    # UNIT TEST 17 â€” RoomOrderNodes valid
    # ==================================================
    - name: Unit Test 17 â€” RoomOrderNodes valid
      run: |
        set -e
        grep '"roomId"' "$PROJECT_FILE" \
        | grep '"path"' \
        | sed -E 's/.*"path":"([^"]+)".*/\1/' \
        | while read r; do
            test -f "$PROJECT_DIR/$r"
          done

    # ==================================================
    # UNIT TEST 18 â€” At least one room ordered
    # ==================================================
    - name: Unit Test 18 â€” RoomOrderNodes not empty
      run: |
        set -e
        grep -q '"RoomOrderNodes":\[' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 19 â€” Resources array exists
    # ==================================================
    - name: Unit Test 19 â€” Resources array exists
      run: |
        set -e
        grep -q '"resources":\[' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 20 â€” Default TextureGroup exists
    # ==================================================
    - name: Unit Test 20 â€” Default TextureGroup exists
      run: |
        set -e
        grep -q '"TextureGroups"' "$PROJECT_FILE"
        grep -q '"Default"' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 21 â€” templateType is game
    # ==================================================
    - name: Unit Test 21 â€” templateType is game
      run: |
        set -e
        grep -q '"templateType":"game"' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 22 â€” IDE metadata exists
    # ==================================================
    - name: Unit Test 22 â€” IDE metadata exists
      run: |
        set -e
        grep -q '"IDEVersion"' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 23 â€” Project name consistency
    # ==================================================
    - name: Unit Test 23 â€” Project name consistency
      run: |
        set -e
        grep -q '"name":"Tower Defense v1(main)"' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 24 â€” Folder structure declared
    # ==================================================
    - name: Unit Test 24 â€” Folder structure declared
      run: |
        set -e
        grep -q '"folderPath"' "$PROJECT_FILE"

    # ==================================================
    # END
    # ==================================================
    - name: Unit Tests Complete
      run: echo "ðŸŽ‰ All 24 unit tests passed â€” real GameMaker validation"
