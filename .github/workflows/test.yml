name: Unit Tests ‚Äì Tower Defense (GameMaker)

on:
  push:
    branches: [cicd]
  pull_request:
    branches: [cicd]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
    # ==================================================
    # SETUP
    # ==================================================
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Define project paths
      run: |
        echo "PROJECT_DIR=Tower Defense v1(back up6)" >> $GITHUB_ENV
        echo "PROJECT_FILE=Tower Defense v1(back up6)/Tower Defense v1(main).yyp" >> $GITHUB_ENV

    # ==================================================
    # UNIT TEST 1 ‚Äî Project file exists
    # ==================================================
    - name: Unit Test 1 ‚Äî Project file exists
      run: |
        set -e
        test -f "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 2 ‚Äî Project file readable
    # ==================================================
    - name: Unit Test 2 ‚Äî Project file readable
      run: |
        set -e
        test -r "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 3 ‚Äî GameMaker project signature
    # ==================================================
    - name: Unit Test 3 ‚Äî GameMaker project signature
      run: |
        set -e
        grep -q '"$GMProject"' "$PROJECT_FILE"
        grep -q '"resourceType":"GMProject"' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 4 ‚Äî Required root sections
    # ==================================================
    - name: Unit Test 4 ‚Äî Required root sections exist
      run: |
        set -e
        for k in '"resources"' '"Folders"' '"RoomOrderNodes"' '"TextureGroups"' '"AudioGroups"'; do
          grep -q "$k" "$PROJECT_FILE"
        done

    # ==================================================
    # UNIT TEST 5 ‚Äî isEcma configuration (REAL ASSERTION)
    # ==================================================
    - name: Unit Test 5 ‚Äî Validate isEcma configuration
      run: |
        set -euo pipefail
        LINE=$(grep '"isEcma"' "$PROJECT_FILE" | head -n 1)
        echo "Detected isEcma line: $LINE"
        echo "$LINE" | grep -q '"isEcma":false' || {
          echo "‚ùå isEcma must be false"
          exit 1
        }

    # ==================================================
    # UNIT TEST 6 ‚Äî Required directories exist
    # ==================================================
    - name: Unit Test 6 ‚Äî Required directories exist
      run: |
        set -e
        for d in fonts notes objects paths rooms scripts sequences shaders sounds sprites; do
          test -d "$PROJECT_DIR/$d"
        done

    # ==================================================
    # UNIT TEST 7 ‚Äî Scripts exist
    # ==================================================
    - name: Unit Test 7 ‚Äî Scripts exist
      run: |
        set -e
        find "$PROJECT_DIR/scripts" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 8 ‚Äî Objects exist
    # ==================================================
    - name: Unit Test 8 ‚Äî Objects exist
      run: |
        set -e
        find "$PROJECT_DIR/objects" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 9 ‚Äî Rooms exist
    # ==================================================
    - name: Unit Test 9 ‚Äî Rooms exist
      run: |
        set -e
        find "$PROJECT_DIR/rooms" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 10 ‚Äî Resource paths exist
    # ==================================================
    - name: Unit Test 10 ‚Äî Resource paths exist
      run: |
        set -e
        grep '"path":"' "$PROJECT_FILE" \
        | sed -E 's/.*"path":"([^"]+)".*/\1/' \
        | while read p; do
            test -f "$PROJECT_DIR/$p"
          done

    # ==================================================
    # UNIT TEST 11 ‚Äî No duplicate resource IDs (GameMaker-correct)
    # ==================================================
    - name: Unit Test 11 ‚Äî No duplicate resource IDs
      run: |
        set -e
    
        grep '"id":{' "$PROJECT_FILE" \
        | sed -E 's/.*"name":"([^"]+)".*"path":"([^"]+)".*/\1|\2/' \
        | sort \
        | uniq -d \
        | tee /tmp/duplicates.txt
    
        if [ -s /tmp/duplicates.txt ]; then
          echo "‚ùå Duplicate resource IDs found:"
          cat /tmp/duplicates.txt
          exit 1
        fi
    
        echo "‚úÖ No duplicate resource IDs"


    # ==================================================
    # UNIT TEST 12 ‚Äî RoomOrderNodes valid
    # ==================================================
    - name: Unit Test 12 ‚Äî RoomOrderNodes valid
      run: |
        set -e
        grep '"roomId"' "$PROJECT_FILE" \
        | grep '"path"' \
        | sed -E 's/.*"path":"([^"]+)".*/\1/' \
        | while read r; do
            test -f "$PROJECT_DIR/$r"
          done

    # ==================================================
    # UNIT TEST 13 ‚Äî Fonts exist
    # ==================================================
    - name: Unit Test 13 ‚Äî Fonts exist
      run: |
        set -e
        find "$PROJECT_DIR/fonts" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 14 ‚Äî Sprites exist
    # ==================================================
    - name: Unit Test 14 ‚Äî Sprites exist
      run: |
        set -e
        find "$PROJECT_DIR/sprites" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 15 ‚Äî Sounds exist
    # ==================================================
    - name: Unit Test 15 ‚Äî Sounds exist
      run: |
        set -e
        find "$PROJECT_DIR/sounds" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 16 ‚Äî Sequences exist
    # ==================================================
    - name: Unit Test 16 ‚Äî Sequences exist
      run: |
        set -e
        find "$PROJECT_DIR/sequences" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 17 ‚Äî Shaders exist
    # ==================================================
    - name: Unit Test 17 ‚Äî Shaders exist
      run: |
        set -e
        find "$PROJECT_DIR/shaders" -name "*.yy" | grep -q .

    # ==================================================
    # UNIT TEST 18 ‚Äî Resources array not empty
    # ==================================================
    - name: Unit Test 18 ‚Äî Resources array not empty
      run: |
        set -e
        grep -q '"resources":\[' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 19 ‚Äî AudioGroups defined
    # ==================================================
    - name: Unit Test 19 ‚Äî AudioGroups defined
      run: |
        set -e
        grep -q '"AudioGroups"' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 20 ‚Äî TextureGroups include Default
    # ==================================================
    - name: Unit Test 20 ‚Äî Default TextureGroup exists
      run: |
        set -e
        grep -q '"TextureGroups"' "$PROJECT_FILE"
        grep -q '"Default"' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 21 ‚Äî Folders list exists
    # ==================================================
    - name: Unit Test 21 ‚Äî Folders list exists
      run: |
        set -e
        grep -q '"Folders":\[' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 22 ‚Äî RoomOrderNodes list exists
    # ==================================================
    - name: Unit Test 22 ‚Äî RoomOrderNodes list exists
      run: |
        set -e
        grep -q '"RoomOrderNodes":\[' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 23 ‚Äî templateType is game
    # ==================================================
    - name: Unit Test 23 ‚Äî Project templateType
      run: |
        set -e
        grep -q '"templateType":"game"' "$PROJECT_FILE"

    # ==================================================
    # UNIT TEST 24 ‚Äî IDE metadata present
    # ==================================================
    - name: Unit Test 24 ‚Äî IDE metadata exists
      run: |
        set -e
        grep -q '"IDEVersion"' "$PROJECT_FILE"

    # ==================================================
    # END
    # ==================================================
    - name: Unit Tests Complete
      run: echo "üéâ All 24 GameMaker-accurate unit tests passed"
