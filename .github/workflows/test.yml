name: Unit Tests â€“ Tower Defense (GameMaker)

on:
  push:
    branches: [cicd]
  pull_request:
    branches: [cicd]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
    # =============================
    # SETUP
    # =============================
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Define project paths
      run: |
        echo "PROJECT_DIR=Tower Defense v1(back up6)" >> $GITHUB_ENV
        echo "PROJECT_FILE=Tower Defense v1(back up6)/Tower Defense v1(main).yyp" >> $GITHUB_ENV

    # =============================
    # UNIT TEST 1 â€” Project file exists
    # =============================
    - name: Unit Test 1 â€” Project file exists
      run: |
        test -f "$PROJECT_FILE"
        echo "âœ… Project file exists"

    # =============================
    # UNIT TEST 2 â€” Project file readable
    # =============================
    - name: Unit Test 2 â€” Project file readable
      run: |
        test -r "$PROJECT_FILE"
        echo "âœ… Project file readable"

    # =============================
    # UNIT TEST 3 â€” GameMaker project type
    # =============================
    - name: Unit Test 3 â€” Validate GameMaker project type
      run: |
        grep -q '"resourceType":"GMProject"' "$PROJECT_FILE"
        echo "âœ… Correct GameMaker project type"

    # =============================
    # UNIT TEST 4 â€” Required root keys
    # =============================
    - name: Unit Test 4 â€” Required root keys exist
      run: |
        KEYS=(
          '"resources"'
          '"Folders"'
          '"RoomOrderNodes"'
          '"TextureGroups"'
          '"isEcma"'
        )

        for key in "${KEYS[@]}"; do
          grep -q "$key" "$PROJECT_FILE" || exit 1
        done

        echo "âœ… Required root keys present"

    # =============================
    # UNIT TEST 5 â€” isEcma configuration
    # =============================
    - name: Unit Test 5 â€” isEcma configuration
      run: |
        LINE=$(grep '"isEcma"' "$PROJECT_FILE" | head -n 1)
        echo "Detected: $LINE"

        echo "$LINE" | grep -q 'false'
        echo "âœ… isEcma correctly set to false"

    # =============================
    # UNIT TEST 6 â€” Required directories
    # =============================
    - name: Unit Test 6 â€” Required directories exist
      run: |
        DIRS=(fonts notes objects options paths rooms scripts sequences shaders sounds sprites)

        for d in "${DIRS[@]}"; do
          test -d "$PROJECT_DIR/$d" || exit 1
        done

        echo "âœ… Required directories exist"

    # =============================
    # UNIT TEST 7 â€” At least 1 script
    # =============================
    - name: Unit Test 7 â€” Scripts exist
      run: |
        ls "$PROJECT_DIR/scripts"/*.yy >/dev/null 2>&1
        echo "âœ… Scripts detected"

    # =============================
    # UNIT TEST 8 â€” At least 1 room
    # =============================
    - name: Unit Test 8 â€” Rooms exist
      run: |
        ls "$PROJECT_DIR/rooms"/*.yy >/dev/null 2>&1
        echo "âœ… Rooms detected"

    # =============================
    # UNIT TEST 9 â€” At least 1 object
    # =============================
    - name: Unit Test 9 â€” Objects exist
      run: |
        ls "$PROJECT_DIR/objects"/*.yy >/dev/null 2>&1
        echo "âœ… Objects detected"

    # =============================
    # UNIT TEST 10 â€” Resource paths exist
    # =============================
    - name: Unit Test 10 â€” Resource paths valid
      run: |
        grep '"path":"' "$PROJECT_FILE" | \
        sed -E 's/.*"path":"([^"]+)".*/\1/' | \
        while read p; do
          test -f "$PROJECT_DIR/$p" || exit 1
        done

        echo "âœ… Resource paths valid"

    # =============================
    # UNIT TEST 11 â€” RoomOrderNodes paths valid
    # =============================
    - name: Unit Test 11 â€” Room order valid
      run: |
        grep '"roomId"' "$PROJECT_FILE" | \
        grep '"path"' | \
        sed -E 's/.*"path":"([^"]+)".*/\1/' | \
        while read r; do
          test -f "$PROJECT_DIR/$r" || exit 1
        done

        echo "âœ… Room order valid"

    # =============================
    # UNIT TEST 12 â€” Audio assets exist
    # =============================
    - name: Unit Test 12 â€” Sounds exist
      run: |
        ls "$PROJECT_DIR/sounds"/*.yy >/dev/null 2>&1
        echo "âœ… Sound assets detected"

    # =============================
    # UNIT TEST 13 â€” Sprite assets exist
    # =============================
    - name: Unit Test 13 â€” Sprites exist
      run: |
        ls "$PROJECT_DIR/sprites"/*.yy >/dev/null 2>&1
        echo "âœ… Sprite assets detected"

    # =============================
    # UNIT TEST 14 â€” Shader assets exist
    # =============================
    - name: Unit Test 14 â€” Shaders exist
      run: |
        ls "$PROJECT_DIR/shaders"/*.yy >/dev/null 2>&1
        echo "âœ… Shader assets detected"

    # =============================
    # UNIT TEST 15 â€” Sequence assets exist
    # =============================
    - name: Unit Test 15 â€” Sequences exist
      run: |
        ls "$PROJECT_DIR/sequences"/*.yy >/dev/null 2>&1
        echo "âœ… Sequence assets detected"

    # =============================
    # UNIT TEST 16 â€” No empty resource paths
    # =============================
    - name: Unit Test 16 â€” No empty resource paths
      run: |
        grep '"path":""' "$PROJECT_FILE" && exit 1 || true
        echo "âœ… No empty resource paths"

    # =============================
    # UNIT TEST 17 â€” Project name matches
    # =============================
    - name: Unit Test 17 â€” Project name consistency
      run: |
        grep -q '"name":"Tower Defense v1(main)"' "$PROJECT_FILE"
        echo "âœ… Project name matches"

    # =============================
    # UNIT TEST 18 â€” Project not empty
    # =============================
    - name: Unit Test 18 â€” Project not empty
      run: |
        grep -q '"resources":\[' "$PROJECT_FILE"
        echo "âœ… Project contains resources"

    # =============================
    # END
    # =============================
    - name: Unit Tests Complete
      run: echo "ðŸŽ‰ All 18 unit tests passed (100% logical coverage)"
