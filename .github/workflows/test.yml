name: Unit Tests – GameMaker Project

on:
  push:
    branches: [cicd]
  pull_request:
    branches: [cicd]

env:
  COVERAGE_THRESHOLD: '100'
  RERUNS: '2'

jobs:
  validate-project:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Locate GameMaker project file
        id: locate
        run: |
          PROJECT="Tower Defense v1(back up6)"
          PROJECT_FILE=$(ls "$PROJECT"/*.yyp 2>/dev/null || true)

          if [ -z "$PROJECT_FILE" ]; then
            echo "❌ No GameMaker (.yyp) project found"
            exit 1
          fi

          echo "Found=$PROJECT_FILE" >> $GITHUB_OUTPUT
          echo "✅ Found project file: $PROJECT_FILE"

      - name: Validate JSON syntax
        run: |
          jq . "Tower Defense v1(back up6)"/*.yyp > /dev/null
          echo "✅ Valid JSON structure"

      - name: Validate required GameMaker keys
        run: |
          jq -e '.resources' "Tower Defense v1(back up6)"/*.yyp > /dev/null
          jq -e '.Folders' "Tower Defense v1(back up6)"/*.yyp > /dev/null
          jq -e '.RoomOrderNodes' "Tower Defense v1(back up6)"/*.yyp > /dev/null
          echo "✅ Required project sections exist"

      - name: Validate all resource paths exist
        run: |
          jq -r '.resources[].id.path' "Tower Defense v1(back up6)"/*.yyp | while read path; do
            if [ ! -f "$path" ]; then
              echo "❌ Missing resource file: $path"
              exit 1
            fi
          done

          echo "✅ All declared resources exist"

  run-tests:
    name: Run tests and collect reports
    runs-on: ubuntu-latest
    needs: validate-project

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect project type
        id: detect
        run: |
          echo "detected=" >> $GITHUB_OUTPUT
          if [ -f package.json ]; then
            echo "detected=js" >> $GITHUB_OUTPUT
          elif [ -f pyproject.toml ] || [ -f requirements.txt ]; then
            echo "detected=python" >> $GITHUB_OUTPUT
          else
            echo "detected=none" >> $GITHUB_OUTPUT
          fi
          cat $GITHUB_OUTPUT

      - name: Set up environment for JavaScript
        if: steps.detect.outputs.detected == 'js'
        run: |
          node -v || true
          npm --version || true
          npm install
          npm install --no-save jest-junit || true

      - name: Set up environment for Python
        if: steps.detect.outputs.detected == 'python'
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-rerunfailures junit-xml || true
          if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi

      - name: Run tests (JS: npm test, Py: pytest)
        id: run_tests
        continue-on-error: true
        run: |
          mkdir -p reports
          if [ "${{ steps.detect.outputs.detected }}" = "js" ]; then
            # Attempt to run npm test and produce junit
            if grep -q "jest" package.json 2>/dev/null; then
              # Configure jest-junit via env
              export JEST_JUNIT_OUTPUT=reports/junit.xml
              npm test -- --ci || true
            else
              npm test || true
            fi
          elif [ "${{ steps.detect.outputs.detected }}" = "python" ]; then
            pytest -q --junitxml=reports/junit.xml --cov=./ --cov-report=xml:reports/coverage.xml --reruns $RERUNS || true
          else
            echo "No test runner detected. Skipping test execution." > reports/README.txt
          fi

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: reports

      - name: Evaluate coverage threshold (Python only)
        if: steps.detect.outputs.detected == 'python'
        id: coverage_check
        run: |
          set -e
          if [ ! -f reports/coverage.xml ]; then
            echo "coverage_file_missing=true" >> $GITHUB_OUTPUT
            echo "No coverage.xml found in reports/; failing coverage check." >&2
            exit 1
          fi
          coverage_percent=$(python - <<'PY'
import xml.etree.ElementTree as ET
root = ET.parse('reports/coverage.xml').getroot()
line_rate = float(root.attrib.get('line-rate','0'))
print(int(line_rate*100))
PY
          echo "coverage=$coverage_percent" >> $GITHUB_OUTPUT
          threshold=${{ env.COVERAGE_THRESHOLD }}
          echo "Threshold is ${threshold}%, actual coverage ${coverage_percent}%"
          if [ "$coverage_percent" -lt "$threshold" ]; then
            echo "Coverage ${coverage_percent}% is below threshold ${threshold}%" >&2
            exit 1
          fi

  report:
    name: Create / Update defect issue when tests fail or coverage is low
    needs: [validate-project, run-tests]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-reports
          path: reports

      - name: Create summary for issue body
        id: make_summary
        run: |
          set -e
          echo "Generating summary..."
          summary_file=reports/summary.md
          echo "## CI Test Summary" > "$summary_file"
          echo "" >> "$summary_file"
          echo "- Repository: $GITHUB_REPOSITORY" >> "$summary_file"
          echo "- Branch: $GITHUB_REF_NAME" >> "$summary_file"
          echo "- Commit: $GITHUB_SHA" >> "$summary_file"

          if [ -f reports/junit.xml ]; then
            python - <<'PY' > /tmp/j
import xml.etree.ElementTree as ET
try:
    t = ET.parse('reports/junit.xml')
    r = t.getroot()
    tests = r.attrib.get('tests','?')
    failures = int(r.attrib.get('failures','0')) + int(r.attrib.get('errors','0'))
    print(f"**Tests:** {tests} tests, {failures} failures/errors")
except Exception as e:
    print('Could not parse junit.xml')
PY
            cat /tmp/j >> "$summary_file"
          else
            echo "- No junit.xml found" >> "$summary_file"
          fi

          if [ -f reports/coverage.xml ]; then
            cov=$(python -c "import xml.etree.ElementTree as ET;print(int(float(ET.parse('reports/coverage.xml').getroot().attrib.get('line-rate','0'))*100))")
            echo "- **Coverage:** ${cov}%" >> "$summary_file"
          else
            echo "- No coverage report found" >> "$summary_file"
          fi

          echo "" >> "$summary_file"
          echo "Artifacts: attached to this workflow run. See 'Artifacts' on the Actions run page." >> "$summary_file"
          echo "::set-output name=body::$(sed 's/%/%%/g' $summary_file | sed ':a;N;$!ba;s/\n/\\n/g')"

      - name: Create or update issue (labels: defect, ci)
        uses: peter-evans/create-or-update-issue@v5
        with:
          title: "CI: Test/coverage failures on ${{ github.ref_name }}"
          body: ${{ steps.make_summary.outputs.body }}
          labels: "defect,ci-failure"
          assignees: scottrepulles
          update-only: false
